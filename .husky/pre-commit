#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Security checks before commit
echo "üîç Running security checks..."

# Check for API keys in staged files
echo "Checking for API keys..."
if git diff --cached --diff-filter=ACM | grep -E "sk-ant-api[0-9]+-[a-zA-Z0-9_-]+"; then
  echo ""
  echo "‚ùå ERROR: API key detected in staged files!"
  echo "API keys should NEVER be committed to the repository."
  echo "Please remove the API key and store it in env.json (which is gitignored)."
  echo ""
  exit 1
fi

# Check for dist/ or build/ directories in staged files
echo "Checking for build artifacts..."
if git diff --cached --name-only | grep -E "^(packages/.*/)?dist/" | grep -v "dist/README.md"; then
  echo ""
  echo "‚ùå ERROR: Build artifacts detected in staged files!"
  echo "dist/ and build/ directories should NEVER be committed."
  echo "Run: git reset HEAD <file> to unstage these files."
  echo ""
  git diff --cached --name-only | grep -E "^(packages/.*/)?dist/"
  echo ""
  exit 1
fi

# Check for env.json (should only allow env.json.example)
echo "Checking for sensitive config files..."
if git diff --cached --name-only | grep -E "env\.json$" | grep -v "env.json.example"; then
  echo ""
  echo "‚ùå ERROR: env.json detected in staged files!"
  echo "This file contains API keys and should NEVER be committed."
  echo "Only env.json.example should be committed."
  echo "Run: git reset HEAD <file> to unstage."
  echo ""
  exit 1
fi

echo "‚úÖ Security checks passed"

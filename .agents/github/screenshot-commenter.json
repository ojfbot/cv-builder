{
  "name": "screenshot-commenter",
  "version": "1.0.0",
  "description": "Attach screenshots to GitHub PR or issue comments using committed images",
  "author": "AI MCP Stack Team",
  "category": "github",
  "capabilities": [
    "attach-screenshots",
    "find-images",
    "extract-metadata",
    "generate-context",
    "intelligent-descriptions",
    "generate-comment",
    "upload-comment"
  ],
  "workflows": {
    "attach-screenshots": [
      {
        "step": "gather-info",
        "description": "Get PR/issue number and screenshot directory",
        "user_interaction": {
          "type": "input",
          "prompts": [
            {
              "name": "pr_or_issue_number",
              "message": "PR or issue number:",
              "required": true
            },
            {
              "name": "screenshot_dir",
              "message": "Screenshot directory path (relative to repo root):",
              "required": false,
              "default": "auto-detect",
              "description": "Use 'auto-detect' to search common locations: temp/screenshots/*, docs/screenshots/*, packages/*/temp/screenshots/*, packages/*/docs/screenshots/*"
            },
            {
              "name": "target_type",
              "message": "Target type (pr or issue):",
              "type": "choice",
              "choices": ["pr", "issue"],
              "default": "pr"
            }
          ]
        }
      },
      {
        "step": "auto-detect-screenshots",
        "action": "action:find-recent-screenshots",
        "description": "Auto-detect screenshot locations if user selected auto-detect",
        "required": false,
        "continue_on_error": false,
        "search_locations": [
          "temp/screenshots/*",
          "docs/screenshots/*",
          "packages/*/temp/screenshots/*",
          "packages/*/docs/screenshots/*",
          "packages/browser-automation/temp/screenshots/*",
          "packages/browser-automation/docs/screenshots/*"
        ],
        "search_strategy": "most_recent_modified",
        "max_age_hours": 24
      },
      {
        "step": "detect-current-branch",
        "action": "action:get-git-branch",
        "description": "Detect current branch for raw.githubusercontent.com URLs",
        "required": true,
        "git_commands": [
          "git rev-parse --abbrev-ref HEAD"
        ]
      },
      {
        "step": "find-screenshots",
        "action": "action:find-screenshot-files",
        "description": "Locate all screenshot files in directory",
        "required": true
      },
      {
        "step": "copy-to-docs",
        "action": "action:copy-screenshots-to-docs",
        "description": "Copy screenshots from temp to permanent docs location",
        "required": true
      },
      {
        "step": "commit-screenshots",
        "action": "action:commit-screenshot-files",
        "description": "Commit screenshot files to current branch",
        "required": true
      },
      {
        "step": "push-to-remote",
        "action": "action:push-screenshots-to-remote",
        "description": "Push committed screenshots to remote repository (REQUIRED before generating URLs)",
        "required": true,
        "git_commands": [
          "git push origin $(git rev-parse --abbrev-ref HEAD)"
        ]
      },
      {
        "step": "get-commit-sha",
        "action": "action:get-commit-sha",
        "description": "Get commit SHA for generating blob URLs",
        "required": true,
        "git_commands": [
          "git rev-parse HEAD"
        ]
      },
      {
        "step": "extract-metadata",
        "action": "action:extract-screenshot-metadata",
        "description": "Extract capture time, file size, and session info from screenshots",
        "required": true
      },
      {
        "step": "generate-context",
        "action": "action:generate-intelligent-context",
        "description": "Generate What/Why/When context based on filename patterns",
        "required": true
      },
      {
        "step": "generate-comment-body",
        "action": "action:generate-screenshot-comment",
        "description": "Generate rich markdown comment with images, context, and metadata",
        "required": true
      },
      {
        "step": "post-comment",
        "command": "command:github-comment-create",
        "description": "Post comment to PR or issue",
        "required": true
      }
    ]
  },
  "permissions": {
    "read": [
      "**/*.png",
      "**/*.jpg",
      "**/*.jpeg",
      "**/*.gif",
      "temp/**",
      "docs/**"
    ],
    "write": [
      "docs/images/**",
      "packages/*/docs/images/**"
    ],
    "execute": [
      "gh",
      "git",
      "find",
      "cp"
    ],
    "github_api": [
      "pull_requests:write",
      "issues:write",
      "repo:read"
    ]
  },
  "triggers": {
    "manual": true,
    "github_action": false,
    "scheduled": false,
    "claude_intents": [
      "attach screenshots",
      "add screenshots to pr",
      "upload images to issue",
      "post screenshots",
      "comment with images"
    ]
  },
  "configuration": {
    "screenshot_extensions": [".png", ".jpg", ".jpeg", ".gif"],
    "max_images_per_comment": 10,
    "docs_image_path": "docs/images",
    "package_docs_pattern": "packages/*/docs/images",
    "commit_screenshots": true,
    "auto_push": true,
    "use_raw_github_urls": true
  },
  "claude": {
    "auto_execute": false,
    "requires_user_confirmation": true,
    "reports_progress": true,
    "estimated_duration": "20-60 seconds",
    "user_guidance": "This agent attaches screenshots to PR or issue comments with rich context and metadata. It AUTO-DETECTS recent screenshots from common locations (temp/screenshots/*, docs/screenshots/*), intelligently describes each screenshot (what/why/when), extracts timestamps and file info, copies to temp/pr-<number>/, commits, and posts detailed comments with working image URLs. Perfect for documenting visual changes, test results, and UI states. Simply provide the PR number - the agent finds the screenshots automatically!",
    "workflow_instructions": {
      "attach-screenshots": {
        "steps": [
          "1. Ask for PR/issue number",
          "2. AUTO-DETECT screenshot location (searches temp/screenshots/*, docs/screenshots/*, packages/*/temp/screenshots/*, packages/*/docs/screenshots/* and uses most recently modified)",
          "3. Get current git commit SHA using `git rev-parse HEAD`",
          "4. Copy screenshots from detected location to temp/pr-{number}/ directory",
          "5. Commit the screenshot files to the current branch",
          "6. CRITICAL: Push the commit to remote repository using `git push origin <branch>` BEFORE generating comment URLs. URLs will NOT work until commit is pushed.",
          "7. Generate markdown comment body with image embeds using blob URLs with ?raw=true parameter (CRITICAL: format MUST be: https://github.com/OWNER/REPO/blob/{commit-sha}/path/to/image.png?raw=true - the ?raw=true is REQUIRED for images to render in markdown. Use COMMIT SHA, not branch name.)",
          "8. Post the comment to the specified PR or issue",
          "9. Report success with comment URL"
        ],
        "error_handling": {
          "no_screenshots_found": "Warn user and ask for alternative directory",
          "commit_failed": "Report error and suggest manual commit",
          "comment_post_failed": "Show generated markdown and suggest manual posting"
        },
        "url_format": "https://github.com/OWNER/REPO/blob/{commit-sha}/path/to/image.png?raw=true",
        "url_format_note": "CRITICAL: Must use blob URLs with ?raw=true parameter, NOT raw.githubusercontent.com URLs. The ?raw=true parameter forces GitHub to serve the raw file which allows markdown image rendering. Format: https://github.com/{owner}/{repo}/blob/{commit-sha}/{path}?raw=true. MUST use commit SHA (from `git rev-parse HEAD`) NOT branch name. Commit MUST be pushed to remote before URLs will work.",
        "commit_detection": "Uses `git rev-parse HEAD` to get commit SHA for URLs",
        "push_requirement": "CRITICAL: After committing screenshots, MUST push to remote with `git push origin <branch>` BEFORE creating PR comment. URLs will 404 if commit is not pushed.",
        "markdown_template_collapsible": "<details>\n<summary><b>[Section Title]</b></summary>\n\n<details>\n<summary>[Screenshot Title]</summary>\n\n![Alt Text](image-url)\n\n[Description]\n</details>\n\n</details>",
        "markdown_format_instructions": "CRITICAL: Use collapsible <details> sections to keep PR threads concise. Nest screenshots under category sections, all collapsed by default. Example: Main section 'Sidebar Toggle Tests (4/4)' contains nested <details> for each screenshot. Users expand only what they need to see.",
        "markdown_template": "## ðŸ“¸ Screenshots\n\n### [Title]\n![Alt Text](image-url)\n\n[Description]",
        "critical_fix": "Always use detected branch name in URLs, not hardcoded branch names"
      }
    }
  },
  "dependencies": {
    "commands": [
      "command:github-comment-create",
      "command:git-current-branch",
      "command:git-add",
      "command:git-commit",
      "command:git-push"
    ],
    "actions": [
      "action:get-git-branch",
      "action:find-screenshot-files",
      "action:copy-screenshots-to-docs",
      "action:commit-screenshot-files",
      "action:generate-screenshot-comment"
    ],
    "tools": [
      "gh",
      "git",
      "find",
      "cp"
    ]
  },
  "outputs": {
    "comment_url": {
      "type": "string",
      "description": "URL of created comment"
    },
    "images_attached": {
      "type": "number",
      "description": "Number of images attached"
    },
    "screenshot_paths": {
      "type": "array",
      "description": "List of committed screenshot paths"
    },
    "comment_markdown": {
      "type": "string",
      "description": "Generated markdown for the comment"
    }
  },
  "examples": [
    {
      "scenario": "Attach browser automation screenshots to PR",
      "user_request": "Attach screenshots from temp/screenshots to PR #22",
      "agent_workflow": [
        "Finds 4 PNG files in packages/browser-automation/temp/screenshots/",
        "Extracts metadata: capture times (2025-11-16 07:29:46), file sizes (78.3 KB), session IDs",
        "Generates intelligent context for each screenshot:",
        "  - cv-builder-dashboard.png: 'Complete dashboard interface' (integration testing)",
        "  - cv-builder-header.png: 'Navigation header' (selector-based feature demo)",
        "  - example-homepage.png: 'Example.com test page' (validates full-page capture)",
        "  - example-h1.png: 'H1 element' (demonstrates CSS selector querying)",
        "Copies to packages/browser-automation/temp/pr-22/",
        "Commits files with descriptive message",
        "Generates rich markdown comment with What/Why/When context and metadata",
        "Posts comment to PR #22",
        "Returns comment URL: https://github.com/ojfbot/cv-builder/pull/22#issuecomment-..."
      ]
    },
    {
      "scenario": "Attach test results screenshots to issue",
      "user_request": "Add test screenshots to issue #18",
      "agent_workflow": [
        "Finds screenshots in temp/test-results/",
        "Copies to docs/images/tests/",
        "Commits screenshot files",
        "Generates comment with organized image layout",
        "Posts to issue #18"
      ]
    }
  ],
  "metadata": {
    "created": "2025-11-16",
    "last_updated": "2025-11-16",
    "version_history": [
      {
        "version": "1.2.0",
        "date": "2025-11-16",
        "changes": "Added AUTOMATIC SCREENSHOT DETECTION. Agent now searches common locations (temp/screenshots/*, docs/screenshots/*, packages/*/temp/screenshots/*, packages/*/docs/screenshots/*) and automatically selects the most recently modified directory. No need to specify screenshot path - just provide PR number!"
      },
      {
        "version": "1.1.0",
        "date": "2025-11-16",
        "changes": "Added automatic git branch detection to fix URL generation issues. Now uses `git rev-parse --abbrev-ref HEAD` to detect current branch and generate correct raw.githubusercontent.com URLs."
      },
      {
        "version": "1.0.0",
        "date": "2025-11-16",
        "changes": "Initial screenshot commenter agent for PR/issue image attachments"
      }
    ],
    "tags": ["github", "screenshots", "images", "pull-requests", "issues", "attachments"],
    "portable": true,
    "framework_agnostic": true
  }
}

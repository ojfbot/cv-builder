name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Only needs to read repo

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@b6389e24199ff37a98a48f90b95d775af819a95d  # main as of 2025-12-04
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --json --fail

      - name: Check for API keys in code
        run: |
          echo "Checking for hardcoded API keys..."
          if git grep -E "sk-ant-api[0-9]{2}-[A-Za-z0-9_-]{90,}" -- '*.ts' '*.js' '*.tsx' '*.jsx' '*.json' ':!*.example' ':!.github/workflows/security-scan.yml'; then
            echo "❌ ERROR: API keys found in tracked files!"
            exit 1
          else
            echo "✅ No API keys found in code"
          fi

      - name: Verify dist/ not committed
        run: |
          echo "Checking for dist/ artifacts..."
          if git ls-files | grep -E "dist/|build/" | grep -v "dist/README.md"; then
            echo "❌ ERROR: Build artifacts found in git!"
            git ls-files | grep -E "dist/|build/"
            exit 1
          else
            echo "✅ No build artifacts committed"
          fi
